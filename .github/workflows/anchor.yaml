name: Anchor Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Solana
        run: |
          # Устанавливаем Solana в конкретную папку
          sh -c "$(curl -sSfL https://release.solana.com/v1.18.12/install)"
          # Явно добавляем в PATH для всех последующих шагов
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor
        run: npm install -g @coral-xyz/anchor-cli@0.29.0

      - name: Build and Fix
        run: |
          # Добавляем путь вручную для надежности в этом шаге
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          # Ключ
          mkdir -p ~/.config/solana
          solana-keygen new --no-bip39-passphrase -o ~/.config/solana/id.json || echo "exists"
          
          # Генерируем Lock
          cargo generate-lockfile
          
          # РЕШАЕМ ПРОБЛЕМУ AMBIGUOUS: указываем ПОЛНУЮ спецификацию версии 1.6.0
          # Именно она требует Rust 1.77, поэтому мы ее ПРИНУДИТЕЛЬНО понижаем
          cargo update -p borsh@1.6.0 --precise 1.5.1 || echo "borsh 1.6 fix skipped"
          cargo update -p borsh-derive@1.6.0 --precise 1.5.1 || echo "borsh-derive 1.6 fix skipped"
          
          # Фикс для старых компиляторов внутри Solana
          sed -i 's/version = 4/version = 3/g' Cargo.lock
          
          # Запуск
          anchor build
